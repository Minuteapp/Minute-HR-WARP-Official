name: Test GitHub Secrets Configuration

on:
  workflow_dispatch:

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Secrets are Set
        run: |
          echo "Testing GitHub Actions Secrets Configuration..."
          
          # Check if secrets are defined (not their values!)
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå SUPABASE_URL is not set"
            exit 1
          else
            echo "‚úÖ SUPABASE_URL is set"
          fi
          
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "‚ùå SUPABASE_ANON_KEY is not set"
            exit 1
          else
            echo "‚úÖ SUPABASE_ANON_KEY is set"
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "‚ùå SUPABASE_SERVICE_KEY is not set"
            exit 1
          else
            echo "‚úÖ SUPABASE_SERVICE_KEY is set"
          fi
          
          if [ -z "${{ secrets.SUPABASE_PROJECT_ID }}" ]; then
            echo "‚ùå SUPABASE_PROJECT_ID is not set"
            exit 1
          else
            echo "‚úÖ SUPABASE_PROJECT_ID is set"
          fi
          
          if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "‚ö†Ô∏è  SUPABASE_ACCESS_TOKEN is not set (needed for CLI deployments)"
          else
            echo "‚úÖ SUPABASE_ACCESS_TOKEN is set"
          fi
          
          echo ""
          echo "‚úÖ All required secrets are configured!"

      - name: Test Supabase Connection
        run: |
          echo "Testing Supabase connection..."
          
          # Test API endpoint
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/")
          
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 401 ] || [ "$RESPONSE" -eq 404 ]; then
            echo "‚úÖ Supabase API is reachable (HTTP $RESPONSE)"
          else
            echo "‚ùå Supabase API returned unexpected status: $RESPONSE"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "üéâ GitHub Actions Secrets Test Complete!"
          echo ""
          echo "Next steps:"
          echo "1. The deployment workflow is now ready at .github/workflows/deploy-supabase.yml"
          echo "2. Push changes to the 'supabase/' folder to trigger automatic deployment"
          echo "3. Or run deployment manually via Actions tab ‚Üí Deploy to Supabase ‚Üí Run workflow"
